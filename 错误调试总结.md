





以下是最近约 20 轮排查/修复的“调试纪要”，方便集中回顾：

---

## 1. 首轮无输出 / 标签缺失
- **问题**：模型常以 emoji/Markdown 标题开头，后端无法识别 `<Analyze>`，导致首轮直接卡死。
- **修复**：新增标签归一化与标签闭合补救逻辑（@demo/backend.py#784-810、#812-829）。
- **效果**：任意 emoji/`## Analyze` 都会被转换为标准 `<Analyze>`，并自动补齐缺失的 `</Code>`。

## 2. 首轮 schema 不执行 / 路径找不到
- **问题**：工作区存在子目录（如 example/.../student_loan.sqlite），旧实现只在根目录找 `.sqlite`。
- **修复**：[iter_sqlite_files](cci:1://file:///d:/Python-Learning/deepanalyze/demo/backend.py:252:0-264:33) + 递归查找 + [run_schema_bootstrap](cci:1://file:///d:/Python-Learning/deepanalyze/demo/backend.py:897:0-909:44) 自动注入 `<Analyze>/<Code>/<Execute>`（@demo/backend.py#229-305、#842-909、#1090-1107）。
- **效果**：即使模型沉默，系统也会自动执行 `sqlite_master` 并把真实表结构注入上下文。

## 3. 反复查询 `sqlite_master` / 无法推进 EDA
- **问题**：模型倾向在多轮输出相同 schema 代码。
- **修复**：检测重复 `<Analyze>`/`<Code>`/`<Execute>`，连续两次 schema 重复即强制终止（@demo/backend.py#1120-1143、#1255-1283、#1519-1535）。
- **效果**：模型被提醒必须转向真实表，避免卡在 “列结构” 循环。

## 4. 代码完整性校验
- **问题**：模型输出的 `<Code>` 片段常缺 `import sqlite3`、`sqlite3.connect` 或只包含 SQL。
- **修复**：在执行前逐项检查 import/连接/plt.savefig 等约束，不满足则退票并提示（@demo/backend.py#1318-1360）。
- **效果**：保证传入 [execute_code_safe](cci:1://file:///d:/Python-Learning/deepanalyze/demo/backend.py:80:0-122:16) 的永远是完整脚本，减少子进程崩溃。

## 5. 真实表引用校验
- **问题**：模型凭空引用 `loan`/`borrower` 等不存在的表，Execution 报错后仍继续。
- **修复**：[extract_table_mentions_from_text](cci:1://file:///d:/Python-Learning/deepanalyze/demo/backend.py:301:0-313:25) + [extract_sql_table_names](cci:1://file:///d:/Python-Learning/deepanalyze/demo/backend.py:316:0-319:17) 判断 `<Analyze>` 是否引用已确认表，并在执行后追加提示（@demo/backend.py#302-333、#1127-1156、#1292-1308）。
- **效果**：模型一旦引用未知表，会在下一轮收到警告并被要求回到 `sqlite_master`。

## 6. 工作区文件追踪与重复文件命名
- **问题**：生成的图/CSV 会覆盖旧文件或无法被下载。
- **修复**：[snapshot_workspace_files](cci:1://file:///d:/Python-Learning/deepanalyze/demo/backend.py:322:0-327:20) + [uniquify_path](cci:1://file:///d:/Python-Learning/deepanalyze/demo/backend.py:364:0-387:14)；新增 [build_download_url](cci:1://file:///d:/Python-Learning/deepanalyze/demo/backend.py:154:0-159:42) 统一下载链接（@demo/backend.py#335-389、#105-160、#1418-1468）。
- **效果**：所有新文件会被复制到 `generated/` 并附上下载 URL。

## 7. 迭代控制 & 退票机制
- **问题**：纠错轮次也计入 `MAX_ITERATIONS`，导致任务尚未真正执行就结束。
- **修复**：[refund_iteration()](cci:1://file:///d:/Python-Learning/deepanalyze/demo/backend.py:850:4-852:41) 在每次提示后回退计数；同时记录 `raw_iterations` 防止死循环（@demo/backend.py#974-1004、#994-1019）。
- **效果**：模型犯错时不会“耗光票数”，但若反复犯同样错误仍会触发上限。

## 8. 循环停滞于 `<Answer>`
- **问题**：在无非 schema 执行结果时仍输出 `<Answer>`。
- **修复**：若 `non_schema_exec_rounds==0` 则忽略 `<Answer>` 并追加提醒（@demo/backend.py#1053-1068）。
- **效果**：只有完成至少两轮真实执行后才允许结论。

## 9. 文件声明与实际产物不一致
- **问题**：模型多次宣称生成 report/CSV，但 `generated/` 为空。
- **修复**：解析 `<File>` 中的文件名，执行后与真实新增文件比对，不匹配则提醒并退票（@demo/backend.py#1221-1497）。
- **效果**：杜绝“口头生成文件”，逼迫模型输出实际脚本。

## 10. 执行日志落地
- **问题**：子进程输出只在控制台可见，复盘困难。
- **修复**：每次执行后将 stdout/stderr 写入 `generated/execute_round_{n}.txt`（@demo/backend.py#1369-1390）。
- **效果**：即使前端无响应，仍可在工作区查到执行记录。

## 11. MAX_PROMPT_CHARS 配置化
- **问题**：环境变量未同步、部署差异导致报错。
- **修复**：`API/config.py` 中新增 `MAX_PROMPT_CHARS`，后端统一读取（@API/config.py、@demo/backend.py#134-143）。
- **效果**：不同环境可通过配置对齐上下文截断长度。

## 12. 迭代终止与答案补写
- **问题**：达到最大迭代或用户停机后没有 `<Answer>` 提示。
- **修复**：若任务被迫结束但仍无 `<Answer>`，自动补写告警（@demo/backend.py#1569-1575）。
- **效果**：前端能感知终止原因。

## 13. 结构化日志与 HTTP 端口
- **问题**：`workspace` 静态服务器与 backend 端口冲突。
- **修复**：将 HTTP server 绑定到 8100 并在后台启动（@demo/backend.py#137-187）。

## 14. 进程中止命令
- **问题**：用户无法中途停止长任务。
- **修复**：`/chat/stop` 设置 `SESSION_STOP_FLAGS`，[bot_stream](cci:1://file:///d:/Python-Learning/deepanalyze/demo/backend.py:809:0-1373:26) 循环中实时检查（@demo/backend.py#191-210、#1564-1568).

## 15. 代码执行 API session 隔离
- **问题**：执行其它会话代码时相互覆盖。
- **修复**：`/execute` API 根据 `session_id` 写入独立 workspace（@demo/backend.py#690-713）。

## 16. 递归 Workspace 文件信息
- **问题**：前端“上传文件信息”传递不完整。
- **修复**：[format_workspace_payload](cci:1://file:///d:/Python-Learning/deepanalyze/demo/backend.py:228:0-252:37) + [collect_file_info](cci:1://file:///d:/Python-Learning/deepanalyze/demo/backend.py:210:0-225:28)，并将其注入系统 prompt（@demo/backend.py#211-251、#943-969）。

## 17. Schema 摘要注入
- **问题**：即便成功运行 schema，模型仍忘记真实表。
- **修复**：首次确认 schema 后由系统追加 PRAGMA 摘要，指明下一步建议（@demo/backend.py#1396-1408）。

## 18. 未知表执行后错误提示
- **问题**：执行结果出现 `no such table` 时用户难以定位。
- **修复**：解析执行输出中的错误，并附带当前 schema 摘要，要求下一轮修复（@demo/backend.py#1534-1555）。

## 19. `<File>` 段统一生成
- **问题**：模型会在 `<Code>` 里写入 `with open()` 但不调用 `plt.savefig()`。
- **修复**：系统根据真实新增/修改文件生成 `<File>`，若没有文件则强制输出“暂无文件”（@demo/backend.py#1418-1468）。

## 20. 仍存在的核心风险
- **模型质量**：即便后端严控流程，只要模型持续拒绝生成合规脚本，仍会触发“提示—退票—再提示”的循环，看似“无输出”。  
- **缺乏运行日志**：若前端完全没有 `<Analyze>` 返回，需查看 `generated/execute_round_*.txt` 或后端控制台。没有这些信息无法定位停顿点。

---
